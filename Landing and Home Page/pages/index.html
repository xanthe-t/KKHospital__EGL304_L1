<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - KKH</title>
    <link rel="stylesheet" href="/index.css">
</head>

<body>

    <header class="topbar">
        <div class="container">
            <h2>KK Hospital</h2>
            <div class="account-info">
                <span id="username-display">Logged in as: <span id="user"></span></span>
                <a href="/logout" class="logout-btn" id="logout-btn">Logout</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="schedule">Work Schedule</button>
            <button class="tab-btn" data-tab="create-user">Create Users</button>
            <button class="tab-btn" data-tab="view-users">View Users</button>
            <button class="tab-btn" data-tab="add-patient">Patients</button>

        </div>

        <!-- Schedule Tab -->
        <div id="tab-schedule" class="tab-section">
            <h1>Work Schedule</h1>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Nurse In-Charge</th>
                        <th>Patients Assigned</th>
                        <th>Workload Quota</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Ward 3A</td>
                        <td>Nur Aisyah</td>
                        <td>
                            • Patient 001 Sarah Lim<br>
                            • Patient 014 Megan Tan
                        </td>
                        <td>2 / 5</td>
                    </tr>
                    <tr>
                        <td>Ward 4B</td>
                        <td>John Lee</td>
                        <td>
                            • Patient 007 Ahmad Rahim<br>
                            • Patient 021 Chloe Ng<br>
                            • Patient 030 Lucas Wong
                        </td>
                        <td>3 / 5</td>
                    </tr>
                    <tr>
                        <td>Ward 2C</td>
                        <td>Lim Jia Wen</td>
                        <td>
                            • Patient 012 Tan Wei<br>
                            • Patient 088 Siti Nur<br>
                        </td>
                        <td>2 / 5</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Create Users Tab -->
        <div id="tab-create-user" class="tab-section" style="display: none;">
            <h1>Create User</h1>
            <form class="create-user-form">
                <div class="input-group">
                    <label for="new-username">Username</label>
                    <input type="text" id="new-username" placeholder="Enter username" required>
                </div>
                <div class="input-group">
                    <label for="new-password">Password</label>
                    <input type="password" id="new-password" placeholder="Enter password" required>
                </div>
                <div class="input-group">
                    <label for="user-role">Role</label>
                    <select id="user-role" required>
                        <option value="" disabled selected>Select role</option>
                        <option value="Administrator">Administrator</option>
                        <option value="User">User</option>
                    </select>
                </div>
                <button type="submit" class="action-btn">Create User</button>
            </form>
        </div>

        <!-- View Users Tab -->
        <div id="tab-view-users" class="tab-section" style="display: none;">
            <h1>All Users</h1>
            <!-- search bar -->
            <input type="text" id="user-search" placeholder="Search users..." class="search-input">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-list">
                    <!-- Filled dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Update User Modal -->
        <div id="update-user-modal" class="modal">
            <div class="modal-content modern-modal">
                <h3>Update User</h3>
                <form id="update-user-form" class="update-user-form">
                    <div class="input-group">
                        <label for="update-username">Username</label>
                        <input type="text" id="update-username" readonly>
                    </div>
                    <div class="input-group">
                        <label for="update-password">Password (leave blank to keep current)</label>
                        <input type="password" id="update-password" placeholder="Enter new password">
                    </div>
                    <div class="input-group">
                        <label for="update-role">Role</label>
                        <select id="update-role">
                            <option value="Administrator">Administrator</option>
                            <option value="User">User</option>
                        </select>
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn-update action-btn">Save</button>
                        <button type="button" id="cancel-update" class="btn-no action-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="tab-add-patient" class="tab-section" style="display: none;">
            <h1>Patient Records</h1>
            <form class="create-patient-form">
                <input type="text" id="patient-name" placeholder="Name" required>
                <input type="text" id="patient-contact" placeholder="Contact Number" required>
                <input type="text" id="patient-history" placeholder="Medical History" required>
                <button id="addPatientBtn" class="action-btn">Add Patient</button>
            </form>

            <table class="patients-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Contact Number</th>
                        <th>Medical History</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="patients-list">
                    <!-- patients list -->
                </tbody>
            </table>
        </div>


        <!-- Logout Confirmation Modal -->
        <div id="logout-modal" class="modal">
            <div class="modal-content">
                <p>Are you sure you want to logout?</p>
                <div class="modal-buttons">
                    <button id="confirm-logout" class="btn-yes">Yes</button>
                    <button id="cancel-logout" class="btn-no">No</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Helper to read cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        const currentUser = getCookie("username");
        document.getElementById("user").innerText = currentUser || "Unknown";

        // Show popup
        function showPopup(message, type = "info") {
            const popup = document.createElement("div");
            popup.className = `popup ${type}`;
            popup.innerText = message;
            document.body.appendChild(popup);
            setTimeout(() => { popup.remove(); }, 3000);
        }

        // TAB SWITCHER
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabSections = document.querySelectorAll(".tab-section");
        tabButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const target = btn.getAttribute("data-tab");
                tabButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                tabSections.forEach(section => {
                    section.style.display = section.id === `tab-${target}` ? "block" : "none";
                });
                if (target === "view-users") loadUsers();
            });
        });

        // Create User
        const createUserForm = document.querySelector(".create-user-form");
        createUserForm.addEventListener("submit", async e => {
            e.preventDefault();
            const username = document.getElementById("new-username").value.trim();
            const password = document.getElementById("new-password").value;
            const role = document.getElementById("user-role").value;

            if (!username || !password || !role) {
                showPopup("Please fill in all fields.", "error");
                return;
            }

            if (password.length < 8) {
                showPopup("Password must be at least 8 characters long.", "error");
                return;
            }

            try {
                const res = await fetch("/create-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password, role })
                });
                const data = await res.json();
                if (data.success) {
                    showPopup("User created successfully!", "success");
                    createUserForm.reset();
                } else {
                    showPopup("Error: " + data.message, "error");
                }
            } catch (err) {
                showPopup("Server error: " + err.message, "error");
            }
        });

        // Load Users
        async function loadUsers() {
            try {
                const res = await fetch("/users");
                const data = await res.json();
                if (!data.success) return;
                const tbody = document.getElementById("users-list");
                tbody.innerHTML = "";
                data.users.forEach(user => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="btn-update" data-username="${user.username}" data-role="${user.role}">Update</button>
                            <button class="btn-remove" data-username="${user.username}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.querySelectorAll(".btn-update").forEach(btn => btn.addEventListener("click", showUpdatePopup));
                document.querySelectorAll(".btn-remove").forEach(btn => btn.addEventListener("click", deleteUser));
            } catch (err) {
                showPopup("Error loading users: " + err.message, "error");
            }
        }

        // search bar
        const userSearch = document.getElementById("user-search");
        userSearch.addEventListener("input", () => {
            const filter = userSearch.value.toLowerCase();
            const rows = document.querySelectorAll("#users-list tr");

            rows.forEach(row => {
                const username = row.cells[0].textContent.toLowerCase();
                const role = row.cells[1].textContent.toLowerCase();
                if (username.includes(filter) || role.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });


        // Delete User
        async function deleteUser(e) {
            const username = e.target.dataset.username;
            if (!confirm(`Are you sure you want to delete ${username}?`)) return;
            try {
                const res = await fetch("/delete-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();
                if (data.success) {
                    showPopup("User deleted successfully!", "success");
                    loadUsers();
                } else {
                    showPopup("Error: " + data.message, "error");
                }
            } catch (err) {
                showPopup("Server error: " + err.message, "error");
            }
        }

        // create Patient
        const createPatientForm = document.querySelector(".create-patient-form");
        createPatientForm.addEventListener("submit", async e => {
            e.preventDefault();
            const name = document.getElementById("patient-name").value.trim();
            const medicalHistory = document.getElementById("patient-history").value.trim();
            const contactNumber = document.getElementById("patient-contact").value.trim();
            // contact validation
            const contactRegex = /^(?:\+65)?[0-9]{8}$/;
            if (!contactRegex.test(contactNumber)) {
                showPopup("Contact number must be at least 8 digits and contain only numbers", "error");
                return;
            }

            if (!name || !contactNumber || !medicalHistory) {
                showPopup("Please fill in all fields.", "error");
                return;
            }

            try {
                const res = await fetch("/create-patient", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, contactNumber, medicalHistory })
                });
                const data = await res.json();
                if (data.success) {
                    showPopup("Patient added successfully!", "success");
                    createPatientForm.reset();
                    loadPatients(); // refresh table
                } else {
                    showPopup("Error: " + data.message, "error");
                }
            } catch (err) {
                showPopup("Server error: " + err.message, "error");
            }
        });
        // load patients
        async function loadPatients() {
            try {
                const res = await fetch("/patients");
                const data = await res.json();

                if (!data.success) return;

                const tbody = document.getElementById("patients-list");
                tbody.innerHTML = "";
                data.patients.forEach(p => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${p.name}</td>
                        <td>${p.contactNumber}</td>
                        <td>${p.medicalHistory}</td>
                        <td>
                            <button class="btn-remove-patient" data-id="${p.id}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });


                // delete patient
                document.querySelectorAll(".btn-remove-patient").forEach(btn => {
                    btn.addEventListener("click", async e => {
                        const id = Number(e.target.dataset.id);
                        if (!confirm(`Delete patient?`)) return;

                        try {
                            const res = await fetch(`/patients/${id}`, { method: "DELETE" });
                            const result = await res.json();

                            if (result.success) {
                                showPopup("Patient deleted successfully!", "success");
                                loadPatients();
                            } else {
                                showPopup("Error: " + result.message, "error");
                            }
                        } catch (err) {
                            showPopup("Server error: " + err.message, "error");
                        }
                    });
                });


            } catch (err) {
                showPopup("Error loading patients: " + err.message, "error");
            }
        }

        loadPatients();


        // Update User Modal
        const updateModal = document.getElementById("update-user-modal");
        const updateForm = document.getElementById("update-user-form");
        const cancelUpdateBtn = document.getElementById("cancel-update");

        function showUpdatePopup(e) {
            const btn = e.target;
            const username = btn.dataset.username;
            let role = btn.dataset.role;
            if (role !== "Administrator" && role !== "User") role = "User";
            document.getElementById("update-username").value = username;
            document.getElementById("update-role").value = role;
            updateModal.style.display = "flex";
        }

        cancelUpdateBtn.addEventListener("click", () => {
            updateModal.style.display = "none";
        });

        updateForm.addEventListener("submit", async e => {
            e.preventDefault();
            const username = document.getElementById("update-username").value.trim();
            const role = document.getElementById("update-role").value;
            if (!username || !role) {
                showPopup("Please fill in all fields.", "error");
                return;
            }
            try {
                const res = await fetch("/update-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, role })
                });
                const data = await res.json();
                if (data.success) {
                    showPopup("User updated successfully!", "success");
                    updateModal.style.display = "none";
                    loadUsers();
                } else {
                    showPopup("Error: " + data.message, "error");
                }
            } catch (err) {
                showPopup("Server error: " + err.message, "error");
            }
        });

        // Logout Modal
        const logoutBtn = document.getElementById("logout-btn");
        const modal = document.getElementById("logout-modal");
        const confirmBtn = document.getElementById("confirm-logout");
        const cancelBtn = document.getElementById("cancel-logout");

        logoutBtn.addEventListener("click", e => {
            e.preventDefault();
            modal.style.display = "flex";
        });

        confirmBtn.addEventListener("click", () => {
            modal.style.display = "none";
            showPopup("You have successfully logged out.", "success");
            setTimeout(() => { window.location.href = "/logout?loggedOut=manual"; }, 2000);
        });

        cancelBtn.addEventListener("click", () => { modal.style.display = "none"; });
        window.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

    </script>
</body>

</html>